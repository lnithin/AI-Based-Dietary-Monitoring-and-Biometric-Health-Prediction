<!DOCTYPE html>
<html>
<head>
    <title>Test Explainability</title>
</head>
<body>
    <h1>Test SHAP/LIME Explainability</h1>
    
    <h2>1. Test CV Service (LIME)</h2>
    <input type="file" id="imageFile" accept="image/*">
    <button onclick="testLIME()">Test LIME</button>
    <div id="limeResult"></div>
    
    <h2>2. Test CV Service (SHAP)</h2>
    <button onclick="testSHAP()">Test SHAP (uses same image)</button>
    <div id="shapResult"></div>
    
    <h2>3. Test LSTM Service (SHAP)</h2>
    <button onclick="testLSTM()">Test LSTM SHAP</button>
    <div id="lstmResult"></div>

    <script>
        let selectedFile = null;
        
        document.getElementById('imageFile').addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
        });

        async function testLIME() {
            if (!selectedFile) {
                alert('Please select an image first');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', selectedFile);
            
            try {
                const response = await fetch('http://localhost:5002/explain/lime', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                document.getElementById('limeResult').innerHTML = 
                    `<pre>${JSON.stringify(data, null, 2)}</pre>` +
                    (data.visualization ? `<img src="data:image/png;base64,${data.visualization}" style="max-width:600px">` : '');
            } catch (error) {
                document.getElementById('limeResult').innerHTML = 
                    `<p style="color:red">Error: ${error.message}</p>`;
            }
        }

        async function testSHAP() {
            if (!selectedFile) {
                alert('Please select an image first');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', selectedFile);
            
            try {
                const response = await fetch('http://localhost:5002/explain/shap', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                document.getElementById('shapResult').innerHTML = 
                    `<pre>${JSON.stringify(data, null, 2)}</pre>` +
                    (data.visualization ? `<img src="data:image/png;base64,${data.visualization}" style="max-width:600px">` : '');
            } catch (error) {
                document.getElementById('shapResult').innerHTML = 
                    `<p style="color:red">Error: ${error.message}</p>`;
            }
        }

        async function testLSTM() {
            const sequenceData = [];
            for (let i = 0; i < 24; i++) {
                sequenceData.push([
                    100 + 20 * Math.sin(i / 4), 50, 20, 15, i % 6 === 0 ? 1 : 0,
                    30, 0.5, 70, 80, 120, 80, 7, 98.6, 150, 50
                ]);
            }
            
            const payload = {
                sequence_data: sequenceData,
                feature_names: ['Glucose', 'Carbs', 'Protein', 'Fat', 'Meal Timing',
                    'Exercise', 'Insulin', 'Heart Rate', 'Stress',
                    'Systolic BP', 'Diastolic BP', 'Sleep', 'Body Temp',
                    'Cholesterol', 'HDL']
            };
            
            try {
                const response = await fetch('http://localhost:5001/api/glucose-prediction/explain/shap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                document.getElementById('lstmResult').innerHTML = 
                    `<pre>${JSON.stringify(data, null, 2)}</pre>` +
                    (data.visualization ? `<img src="data:image/png;base64,${data.visualization}" style="max-width:800px">` : '');
            } catch (error) {
                document.getElementById('lstmResult').innerHTML = 
                    `<p style="color:red">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
